#!/bin/bash

if [ "$1" == "" ] ; then
	echo "usage: pawrapper <appname> <command> [args..]" >> /dev/stderr
	exit 64
fi

APPNAME=$1
shift

exec &>> $HOME/.studio-errors
set -x
set -e

ulimit -l unlimited
ulimit -r 99
unset pulseaudio_running

if PULSE_SERVER=/tmp/pulse-"$APPNAME".socket pactl list > /dev/null 2>&1 ; then
        true
else
	pulseaudio_running="no"
fi

if [ "$pulseaudio_running" == "no" ] ; then
	OLDBUS=$DBUS_SESSION_BUS_ADDRESS
	eval `dbus-launch`
	export DBUS_SESSION_BUS_ADDRESS
	sleep 0.25
	sed "s/%APP%/$APPNAME/" < $HOME/default.pa.template > $HOME/default.pa."$APPNAME"
	pulseaudio -nF $HOME/default.pa."$APPNAME" --realtime &
	sleep 0.25
	sudo chrt -a -f -p 68 `pgrep -f "pulseaudio.*default.pa.$APPNAME"`
	export DBUS_SESSION_BUS_ADDRESS="$OLDBUS"
fi
PULSE_SERVER=/tmp/pulse-"$APPNAME".socket exec "$@"
