#!/bin/bash

exec &>> $HOME/Studio/Logs/recordbroadcast-errors
set -x
set -e
ulimit -l unlimited

while ! pgrep jackd ; do
        echo waiting for jackd >> /dev/stderr
        sleep 1
done

while ! pgrep qjackctl ; do
        echo waiting for QjackCtl >> /dev/stderr
        sleep 1
done

pkill -INT gst-launch || true
sleep 2

recordingdir=$HOME/Studio/Recordings
# this scripts expects it to exist and be writable

source "$HOME"/.recordbroadcast || { notify-send -t 60 'Broadcast recording not configured' 'Configure broadcast recording by opening a terminal and running the command setup-recordbroadcast' ; exit 5 ; }

cd $recordingdir
gst-launch -e jackaudiosrc name=live client-name=live latency-time=20000 \
   ! 'audio/x-raw-float,channels=1' \
   ! queue \
   ! tee name=formattee \
     formattee. \
     ! queue \
     ! audioconvert \
     ! lamemp3enc mono=true quality=2 cbr=true bitrate=64 target=bitrate \
     ! shout2send mount="$MP3_MOUNT" ip="$IP" password="$ICECAST_PASSWORD" port="$PORT" url="$SHOW_URL" streamname="$SHOW_NAME" description="$SHOW_DESCRIPTION" \
     formattee. \
     ! queue \
     ! audioconvert \
     ! vorbisenc max-bitrate=64000 min-bitrate=64000 \
     ! oggmux \
     ! shout2send mount="$OGG_MOUNT" ip="$IP" password="$ICECAST_PASSWORD" port="$PORT" url="$SHOW_URL" streamname="$SHOW_NAME" description="$SHOW_DESCRIPTION" \
&
gst-launch -e jackaudiosrc name=premastered client-name=premastered \
   ! 'audio/x-raw-float,channels=1' \
   ! vorbisenc quality=0.9 \
   ! oggmux \
   ! queue \
   ! filesink append=true location=declinetostate.ogg \
&
sleep 1
for a in `pgrep gst-launch` ; do
sudo chrt -a -f -p 66 $a
done
